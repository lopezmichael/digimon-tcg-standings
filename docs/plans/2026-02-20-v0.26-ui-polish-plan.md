# v0.26 UI Polish & Responsiveness — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Ship 15 UI/UX improvements across dashboard responsiveness, stores tab, filter discoverability, SVG branding, mobile tables, a player modal sparkline, and an admin row-selection fix.

**Architecture:** Pure CSS + minimal R/JS changes. No schema migrations, no new server modules, no new packages. The sparkline (UX3) uses inline SVG computed server-side from existing tournament data — no additional charting library. Map projection (UP10) uses `mapgl::set_projection()` if available, else Mapbox GL JS call via `htmlwidgets::onRender`.

**Tech Stack:** R Shiny, bslib, highcharter, mapgl, reactable, CSS, inline SVG

---

## Task Overview

| # | ID | Description | Files |
|---|-----|-------------|-------|
| 1 | UP1 | Filter prominence across all tabs | `www/custom.css` |
| 2 | UP2 | Pill toggle prominence | `www/custom.css` |
| 3 | UP3 | Hot Deck value box auto-resize text | `www/custom.css`, `app.R` (JS) |
| 4 | UP4 | Top Decks responsive grid | `server/public-dashboard-server.R`, `www/custom.css`, `app.R` (JS) |
| 5 | UP5 | Rising Stars responsive grid | `server/public-dashboard-server.R`, `www/custom.css` |
| 6 | UP6 | Player attendance chart — local only | `server/public-dashboard-server.R` |
| 7 | UP7 | Stores: Cards view as default | `views/stores-ui.R` |
| 8 | UP8 | Stores: Improve card styling | `www/custom.css` |
| 9 | UP9 | Stores: Schedule view — color variety | `www/custom.css`, `server/public-stores-server.R` |
| 10 | UP10 | Stores: Flat map projection (All/Online) | `server/public-stores-server.R` |
| 11 | UX3 | Player modal: rating trend sparkline | `server/public-players-server.R`, `www/custom.css` |
| 12 | I7 | Header Digivice SVG icon | `app.R` |
| 13 | BR1 | Agumon SVG branding — loading screen | `app.R`, `www/custom.css` |
| 14 | M1 | Mobile table column prioritization | `www/custom.css` |
| 15 | BF1 | Admin row selection audit & fix | `server/admin-players-server.R`, `server/admin-decks-server.R` |

---

## Task 1: UP1 — Filter Prominence

Make region/format/event selectors more noticeable across all tabs.

**Files:**
- Modify: `www/custom.css` (DASHBOARD TITLE STRIP section ~line 630, PAGE TITLE STRIPS section ~line 920)

**Current state:** Filters are small (`120-140px`) native `<select>` elements with white-on-dark-blue styling, right-aligned in a compact title strip. They blend into the strip and are easy to miss.

**Step 1: Increase filter visual weight in CSS**

In the "DASHBOARD TITLE STRIP" section (~line 750), update the `.title-strip-select .form-select` rule:

```css
/* Before */
.title-strip-select .form-select {
  background-color: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #333333;
  font-size: 0.8rem;
  padding: 0.3rem 2rem 0.3rem 0.6rem;
  border-radius: 4px;
  cursor: pointer;
  height: auto;
  line-height: 1.3;
}

/* After */
.title-strip-select .form-select {
  background-color: #FFFFFF;
  border: 2px solid rgba(255, 255, 255, 0.6);
  color: #0A3055;
  font-size: 0.85rem;
  font-weight: 600;
  padding: 0.4rem 2.2rem 0.4rem 0.7rem;
  border-radius: 6px;
  cursor: pointer;
  height: auto;
  line-height: 1.3;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
```

Key changes:
- Full white background (not 0.9 alpha) for higher contrast
- Thicker border (`2px`) with more visible stroke
- Bolder text (`font-weight: 600`, slightly larger `0.85rem`)
- Subtle shadow for depth
- Rounded corners (`6px`)

**Step 2: Add filter label hint**

Add a "Filter:" label to the title-strip-controls on all tabs. In the CSS, add a `::before` pseudo-element:

```css
.title-strip-controls::before {
  content: "Filter:";
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  display: flex;
  align-items: center;
  margin-right: 0.25rem;
}
```

**Step 3: Verify all tabs use `.page-title-strip`**

Check that Players, Meta, Tournaments, and Stores tabs all have the same title strip pattern. The CSS changes to `.title-strip-select .form-select` should cascade to all tabs since they share the class.

**Step 4: Test both themes + mobile**

- Light mode: white selects should be visible against the blue strip
- Dark mode: check contrast
- Mobile: selects should expand to full width (existing media query at line 1370)

**Step 5: Commit**

```bash
git add www/custom.css
git commit -m "feat(UP1): increase filter prominence across all tabs"
```

---

## Task 2: UP2 — Pill Toggle Prominence

Make the 5+/10+/All pill toggles more noticeable on Players and Deck Meta tabs.

**Files:**
- Modify: `www/custom.css` (Pill Toggle Controls section ~line 829)

**Current state:** The `.pill-toggle` container has `background: rgba(255, 255, 255, 0.15)` — barely visible against the dark blue title strip. Inactive pills are 70% white text on transparent. The widget is functionally a segmented control but visually disappears.

**Step 1: Increase container contrast and add border**

```css
/* Before */
.pill-toggle {
  display: inline-flex;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 6px;
  padding: 2px;
  gap: 2px;
}

/* After */
.pill-toggle {
  display: inline-flex;
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  padding: 3px;
  gap: 2px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
}
```

**Step 2: Increase inactive pill contrast**

```css
/* Before */
.pill-option {
  ...
  color: rgba(255, 255, 255, 0.7);
  ...
}

/* After */
.pill-option {
  ...
  color: rgba(255, 255, 255, 0.85);
  ...
}
```

**Step 3: Add a label hint before pill toggles**

In `views/players-ui.R` (~line 29) and `views/meta-ui.R` (~line 29), add a small label before the pill toggle:

```r
# Players tab - before the div(class = "pill-toggle", ...)
span(class = "title-strip-pill-label", "Min Events:"),
```

And CSS:

```css
.title-strip-pill-label {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-right: 0.25rem;
}
```

**Step 4: Test**

- Both Players and Deck Meta tabs
- Light and dark mode
- Mobile (pills should wrap cleanly)

**Step 5: Commit**

```bash
git add www/custom.css views/players-ui.R views/meta-ui.R
git commit -m "feat(UP2): increase pill toggle prominence with labels and contrast"
```

---

## Task 3: UP3 — Hot Deck Value Box Auto-Resize Text

Make the Hot Deck name always fit on one line by auto-sizing the font.

**Files:**
- Modify: `www/custom.css` (~line 1261, `.vb-value-deck`)
- Modify: `app.R` (add JS `fitText` helper at end of head scripts)

**Current state:** `.vb-value-deck` uses `clamp(0.85rem, 2vw, 1.1rem)` with `-webkit-line-clamp: 2`, allowing 2-line wrap. Long deck names like "Rapidmon ACE Turbo" wrap awkwardly.

**Approach:** Use a small JS snippet that measures the text and shrinks `font-size` until it fits one line. This runs on each render.

**Step 1: Update CSS for single-line constraint**

```css
/* Replace the existing .vb-value-deck rule */
.vb-value-deck {
  font-size: 1.1rem !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.2;
  max-width: 100%;
}
```

**Step 2: Add fitText JS in app.R**

In the `tags$head(tags$script(...))` section of `app.R`, add:

```js
// Auto-fit deck name text in value boxes
function fitDeckText() {
  document.querySelectorAll('.vb-value-deck').forEach(function(el) {
    var maxWidth = el.parentElement.offsetWidth;
    if (maxWidth === 0) return;
    var fontSize = 1.1;  // rem starting point
    el.style.fontSize = fontSize + 'rem';
    while (el.scrollWidth > maxWidth && fontSize > 0.6) {
      fontSize -= 0.05;
      el.style.fontSize = fontSize + 'rem';
    }
  });
}

// Run on Shiny value render
$(document).on('shiny:value', function(e) {
  if (e.name === 'hot_deck_name' || e.name === 'most_popular_deck_val') {
    setTimeout(fitDeckText, 50);
  }
});
// Also run on window resize
$(window).on('resize', _.debounce ? _.debounce(fitDeckText, 200) : fitDeckText);
```

**Step 3: Remove mobile override**

Delete or update the mobile override at ~line 1404:

```css
/* Remove this - the JS auto-fit handles all sizes now */
/* @media (max-width: 576px) { .vb-value-deck { ... } } */
```

**Step 4: Test**

- Short names ("Gallantmon") — should stay at ~1.1rem
- Long names ("Rapidmon ACE Turbo") — should shrink to fit
- Very long names ("Blue Flare Imperialdramon Dragon Mode") — should shrink, with ellipsis as fallback
- Mobile viewport

**Step 5: Commit**

```bash
git add www/custom.css app.R
git commit -m "feat(UP3): auto-resize Hot Deck value box text to fit one line"
```

---

## Task 4: UP4 — Top Decks Responsive Grid

Scale the number of Top Decks items to fill complete rows at the current viewport width.

**Files:**
- Modify: `server/public-dashboard-server.R` (~line 607, `head(top_data, 6)`)
- Modify: `app.R` (add JS for reporting column count)
- Modify: `www/custom.css` (minor grid tweaks)

**Current state:** Always shows 6 items. CSS grid `repeat(auto-fit, minmax(300px, 1fr))` means: 3 columns on wide, 2 on medium, 1 on mobile. 6 items always fills complete rows. But it doesn't adapt count to viewport.

**Approach:** Rather than complex JS column detection, use a simpler CSS approach: switch from `auto-fit` to explicit column counts at breakpoints, and match the server-side count to the max columns.

**Step 1: Update CSS grid to explicit breakpoints**

```css
.top-decks-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
}

@media (max-width: 991px) {
  .top-decks-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 640px) {
  .top-decks-grid {
    grid-template-columns: 1fr;
  }
}
```

**Step 2: Increase default count from 6 to 9**

In `server/public-dashboard-server.R` (~line 607), change:

```r
# Before
result <- head(top_data, 6)

# After — 9 fills 3×3 on desktop, 2-col trims to 8 (showing 4 rows), 1-col shows all 9
result <- head(top_data, 9)
```

9 is divisible by 3 (3×3 on desktop). On medium (2-col), the 9th item creates an incomplete row — but `auto-fit` stretches it to full width which looks fine. Alternatively, keep at 6 for clean rows at both 2-col and 3-col.

**Decision point:** If 6 is preferred for clean rows everywhere, keep 6 and just refine the CSS. If more data is desired, go to 9 on desktop with a JS approach. **Recommend keeping 6** with the explicit breakpoint CSS for simplicity.

**Step 3: Update header to show count**

In `server/public-dashboard-server.R`, the `output$top_decks_header` already shows "Top Decks" — no change needed.

**Step 4: Test**

- Wide (>992px): 3 columns × 2 rows = 6 items
- Medium (641-991px): 2 columns × 3 rows = 6 items
- Mobile (<=640px): 1 column × 6 items

**Step 5: Commit**

```bash
git add www/custom.css server/public-dashboard-server.R
git commit -m "feat(UP4): responsive Top Decks grid with explicit breakpoints"
```

---

## Task 5: UP5 — Rising Stars Responsive Grid

Same responsive row-filling behavior as Top Decks.

**Files:**
- Modify: `www/custom.css` (~line 1457, `.rising-stars-grid`)
- Modify: `server/public-dashboard-server.R` (~line 1160, `LIMIT 4`)

**Current state:** 4 items, CSS `repeat(auto-fit, minmax(200px, 1fr))`. 4 items on wide = 1 row of 4. 2-col = 2×2. 1-col = 4 rows.

**Step 1: Update CSS grid to explicit breakpoints**

```css
.rising-stars-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.75rem;
}

@media (max-width: 1200px) {
  .rising-stars-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 640px) {
  .rising-stars-grid {
    grid-template-columns: 1fr;
  }
}
```

**Step 2: Keep LIMIT 4**

4 fills 1×4 on wide, 2×2 on medium, 4×1 on mobile — all complete rows. No change needed.

**Step 3: Test**

- All three breakpoints
- Verify star cards don't overflow or get too narrow

**Step 4: Commit**

```bash
git add www/custom.css
git commit -m "feat(UP5): responsive Rising Stars grid with explicit breakpoints"
```

---

## Task 6: UP6 — Player Attendance Chart (Local Only)

Filter the attendance chart to exclude online events, preventing outlier skew.

**Files:**
- Modify: `server/public-dashboard-server.R` (~line 790, `build_community_filters`)

**Current state:** Uses `build_community_filters("t", "s")` which only applies scene filter. When scene is "all", online tournaments with large player counts skew the average. The chart shows `AVG(t.player_count)` which is inflated by online events with 50-100+ players vs locals with 8-20.

**Step 1: Add `is_online = FALSE` filter to attendance query**

In `server/public-dashboard-server.R` (~line 790), in the `output$tournaments_trend_chart` block, add the online exclusion directly in the WHERE clause:

```r
# Before
result <- safe_query(rv$db_con, paste("
  SELECT t.event_date,
         COUNT(*) as tournaments,
         ROUND(AVG(t.player_count), 1) as avg_players
  FROM tournaments t
  JOIN stores s ON t.store_id = s.store_id
  WHERE 1=1", filters$sql, "
  GROUP BY t.event_date
  ORDER BY t.event_date
"), params = filters$params, ...)

# After — exclude online unless scene is specifically "online"
online_filter <- if (!is.null(rv$current_scene) && rv$current_scene == "online") {
  ""  # Don't exclude online when viewing Online scene
} else {
  "AND (s.is_online = FALSE OR s.is_online IS NULL)"
}

result <- safe_query(rv$db_con, paste("
  SELECT t.event_date,
         COUNT(*) as tournaments,
         ROUND(AVG(t.player_count), 1) as avg_players
  FROM tournaments t
  JOIN stores s ON t.store_id = s.store_id
  WHERE 1=1", filters$sql, online_filter, "
  GROUP BY t.event_date
  ORDER BY t.event_date
"), params = filters$params, ...)
```

**Step 2: Update cache key**

The `bindCache()` call already includes `rv$current_scene`, so it will correctly invalidate when scene changes. No change needed.

**Step 3: Test**

- "All" scene: should show only local events
- "DFW" scene: same (local DFW stores only)
- "Online" scene: should show online events
- Verify avg_players values look reasonable (8-20 range for locals)

**Step 4: Commit**

```bash
git add server/public-dashboard-server.R
git commit -m "feat(UP6): filter attendance chart to local events only"
```

---

## Task 7: UP7 — Stores: Cards View as Default

Switch the default Stores view from Schedule to Cards.

**Files:**
- Modify: `views/stores-ui.R` (~lines 44-53 for button classes, ~line 73 for hidden input)

**Step 1: Swap active class and default value**

```r
# Before (stores-ui.R ~line 44-53)
actionButton(
  "stores_view_schedule",
  tagList(bsicons::bs_icon("calendar-week"), " Schedule"),
  class = "btn-outline-primary active"   # <-- was default
),
actionButton(
  "stores_view_all",
  tagList(bsicons::bs_icon("grid-3x3-gap"), " Cards"),
  class = "btn-outline-primary"
)

# After
actionButton(
  "stores_view_schedule",
  tagList(bsicons::bs_icon("calendar-week"), " Schedule"),
  class = "btn-outline-primary"
),
actionButton(
  "stores_view_all",
  tagList(bsicons::bs_icon("grid-3x3-gap"), " Cards"),
  class = "btn-outline-primary active"   # <-- now default
)
```

```r
# Before (stores-ui.R ~line 73)
tags$input(type = "hidden", id = "stores_view_mode", value = "schedule", ...)

# After
tags$input(type = "hidden", id = "stores_view_mode", value = "all", ...)
```

**Step 2: Verify conditional panels**

Check the `conditionalPanel` logic in `stores-ui.R`. The schedule panel shows when `input.stores_view_mode != 'all'` and cards shows when `input.stores_view_mode == 'all'`. With the default now `"all"`, cards will show first. No logic change needed.

**Step 3: Test**

- Load stores tab — should show cards grid by default
- Click Schedule toggle — should switch to schedule view
- Click Cards toggle — should switch back

**Step 4: Commit**

```bash
git add views/stores-ui.R
git commit -m "feat(UP7): make Cards view default on Stores tab"
```

---

## Task 8: UP8 — Stores: Improve Card Styling

Give store cards a visible resting state instead of blending into the background.

**Files:**
- Modify: `www/custom.css` (~line 6064, `.store-card-item`)

**Current state:** `.store-card-item` uses `background: var(--bs-body-bg)` — identical to page background, invisible at rest. Only visible on hover.

**Step 1: Add visible card treatment**

```css
/* Before */
.store-card-item {
  background: var(--bs-body-bg);
  border-radius: 8px;
  transition: all 0.2s ease;
  cursor: pointer;
}

/* After */
.store-card-item {
  background: var(--bs-body-bg);
  border: 1px solid rgba(0, 0, 0, 0.08);
  border-radius: 8px;
  transition: all 0.2s ease;
  cursor: pointer;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
}

.store-card-item:hover {
  background: rgba(var(--bs-primary-rgb), 0.06);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  border-color: rgba(var(--bs-primary-rgb), 0.2);
}
```

**Step 2: Dark mode variant**

```css
[data-bs-theme="dark"] .store-card-item {
  border-color: rgba(255, 255, 255, 0.08);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

[data-bs-theme="dark"] .store-card-item:hover {
  border-color: rgba(0, 200, 255, 0.2);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
```

**Step 3: Test**

- Light mode: cards should have subtle border + shadow at rest
- Dark mode: same
- Hover: lift effect with primary color tint

**Step 4: Commit**

```bash
git add www/custom.css
git commit -m "feat(UP8): add visible card treatment to store cards"
```

---

## Task 9: UP9 — Stores: Schedule View — Fix Orange Text, Add Color Variety

**Root cause:** The `.schedule-day-header` uses `color: var(--bs-secondary-color)` (CSS line 5981). Because `_brand.yml` sets `secondary: digimon_orange (#F7941D)`, **all schedule text inherits orange** — day headers, store names, city, turnout, and times all render in orange/orange-tinted text through the Bootstrap secondary color cascade.

**Goal:** Replace the orange text with a proper neutral palette, then add tasteful color variety through day-of-week accents.

**Files:**
- Modify: `www/custom.css` (STORES SCHEDULE VIEW section ~line 5961)
- Modify: `server/public-stores-server.R` (~line 135 for schedule rendering, ~line 155 for item classes)

**Step 1: Fix schedule day header color**

In `www/custom.css` (~line 5976), replace the orange secondary color with an explicit neutral:

```css
/* Before */
.schedule-day-header {
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--bs-secondary-color);  /* Resolves to orange via _brand.yml */
  margin-bottom: 0.5rem;
  padding: 0.25rem 0;
}

/* After */
.schedule-day-header {
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #4A5568;  /* Neutral slate gray — matches brand palette 'slate' */
  margin-bottom: 0.5rem;
  padding: 0.25rem 0;
}

[data-bs-theme="dark"] .schedule-day-header {
  color: #A0AEC0;  /* Light slate for dark mode */
}
```

**Step 2: Override text color in schedule store items**

The `.schedule-store-item` elements contain child spans using `text-muted` and `fw-medium` which may inherit orange. Explicitly set their colors:

```css
/* Force schedule item text to neutral colors */
.schedule-store-item {
  color: var(--bs-body-color);  /* Use body text color, not secondary */
}

.schedule-store-item .text-muted {
  color: #64748B !important;  /* Explicit gray, overrides secondary-tinted muted */
}

[data-bs-theme="dark"] .schedule-store-item .text-muted {
  color: #94A3B8 !important;
}
```

**Step 3: Add day-of-week color accents via left border**

In `server/public-stores-server.R` (~line 135), add a day-specific class to each section:

```r
# Inside the lapply(day_order, function(day_idx) { ... }) block
day_keys <- c("sun", "mon", "tue", "wed", "thu", "fri", "sat")
day_class <- paste0("schedule-day--", day_keys[day_idx + 1])

div(
  class = paste("schedule-day-section mb-3", day_class),
  # ... rest of the div content unchanged
)
```

And add the CSS color accents:

```css
/* Day-of-week color accents */
.schedule-day--sun { border-left: 3px solid #E5383B; padding-left: 0.75rem; }
.schedule-day--mon { border-left: 3px solid #2D7DD2; padding-left: 0.75rem; }
.schedule-day--tue { border-left: 3px solid #38A169; padding-left: 0.75rem; }
.schedule-day--wed { border-left: 3px solid #EAB308; padding-left: 0.75rem; }
.schedule-day--thu { border-left: 3px solid #7C3AED; padding-left: 0.75rem; }
.schedule-day--fri { border-left: 3px solid #0EA5E9; padding-left: 0.75rem; }
.schedule-day--sat { border-left: 3px solid #EC4899; padding-left: 0.75rem; }
```

Note: Uses the brand's categorical palette colors (no orange — Wed uses yellow instead).

**Step 4: Test**

- Schedule view day headers should be neutral gray, NOT orange
- Store names, city, turnout, times should be neutral text colors
- Each day section should have a distinct colored left border
- Today's header should still override to blue (`var(--bs-primary)` via `.schedule-day-today`)
- Both light and dark mode

**Step 5: Commit**

```bash
git add www/custom.css server/public-stores-server.R
git commit -m "feat(UP9): fix orange schedule text and add day-color accents"
```

---

## Task 10: UP10 — Flat Map Projection for All/Online Scenes

Replace the globe projection with a flat (Mercator) projection when viewing All or Online scenes.

**Files:**
- Modify: `server/public-stores-server.R` (~lines 870, 932, 1037 — all `atom_mapgl()` calls for main maps)

**Current state:** `atom_mapgl(theme = "digital")` uses Mapbox GL JS default projection. In Mapbox GL JS v3+, the default is `globe` at low zoom levels, which shows a 3D globe — not ideal for a world overview of online stores.

**Approach:** Use `htmlwidgets::onRender()` to call `map.setProjection('mercator')` after map initialization. This avoids needing `mapgl` R package updates.

**Step 1: Add mercator projection to online stores map**

In `server/public-stores-server.R` (~line 932), pipe an `onRender` call:

```r
# Online organizers world map
atom_mapgl(theme = "digital") |>
  add_atom_popup_style(theme = "light") |>
  mapgl::add_circle_layer(
    id = "online-stores-layer",
    source = stores_sf,
    circle_color = "#10B981",
    circle_radius = list("get", "bubble_size"),
    circle_stroke_color = "#FFFFFF",
    circle_stroke_width = 2,
    circle_opacity = 0.85,
    popup = "popup"
  ) |>
  mapgl::set_view(center = c(-40, 20), zoom = 1.5) |>
  htmlwidgets::onRender("function(el, x) {
    var map = this.getMap ? this.getMap() : el._map || el.map;
    if (map && map.setProjection) {
      map.setProjection('mercator');
    }
  }")
```

**Step 2: Add to empty world maps too**

Apply the same `onRender` to the empty world map fallbacks (~lines 870, 895).

**Step 3: Physical stores map — keep globe for local scenes**

The physical stores map (local scenes like DFW) shows a zoomed-in regional view where globe vs mercator doesn't matter. Only apply mercator to the Online stores map and the "All" scene main map when it shows the full world.

**Step 4: Test**

- Online scene → world map should be flat Mercator (no globe curvature)
- All scene → online stores section should be flat
- DFW scene → local stores map should look the same as before
- Zoom in/out should work normally

**Step 5: Commit**

```bash
git add server/public-stores-server.R
git commit -m "feat(UP10): use flat Mercator projection for Online/All scene maps"
```

---

## Task 11: UX3 — Player Modal Rating Trend Sparkline

Add a mini line chart showing rating trend in the player detail modal.

**Files:**
- Modify: `server/public-players-server.R` (~line 328, modal content rendering)
- Modify: `www/custom.css` (add sparkline styles)

**Current state:** Player modal shows current rating as a number. No historical trend. The `calculate_competitive_ratings()` function in `R/ratings.R` iterates through tournaments chronologically and could track per-tournament ratings, but currently only returns final values.

**Approach:** Instead of modifying the Elo computation, compute a simpler "placement percentile" sparkline from the player's result history. This shows performance trend without needing a rating history table. We compute the sparkline as an inline SVG polyline — no charting library needed.

**Step 1: Add sparkline helper function**

In `server/public-players-server.R`, add a helper function near the top of the file:

```r
# Generate inline SVG sparkline from a numeric vector
make_sparkline_svg <- function(values, width = 120, height = 24, color = "#00C8FF") {
  if (length(values) < 2) return(NULL)

  # Normalize to 0-1 range (invert so higher = better)
  min_val <- min(values, na.rm = TRUE)
  max_val <- max(values, na.rm = TRUE)
  if (max_val == min_val) {
    normalized <- rep(0.5, length(values))
  } else {
    normalized <- (values - min_val) / (max_val - min_val)
  }

  # Build SVG points
  n <- length(normalized)
  x_step <- (width - 4) / max(n - 1, 1)
  points <- paste(
    sapply(seq_along(normalized), function(i) {
      x <- 2 + (i - 1) * x_step
      y <- 2 + (1 - normalized[i]) * (height - 4)  # invert Y axis
      sprintf("%.1f,%.1f", x, y)
    }),
    collapse = " "
  )

  # Trend direction for end dot color
  trend_up <- normalized[n] > normalized[max(1, n - 3)]
  dot_color <- if (trend_up) "#38A169" else "#E5383B"
  last_x <- 2 + (n - 1) * x_step
  last_y <- 2 + (1 - normalized[n]) * (height - 4)

  sprintf(
    '<svg class="rating-sparkline" width="%d" height="%d" viewBox="0 0 %d %d">
      <polyline points="%s" fill="none" stroke="%s" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="%.1f" cy="%.1f" r="2.5" fill="%s"/>
    </svg>',
    width, height, width, height, points, color, last_x, last_y, dot_color
  )
}
```

**Step 2: Query rating history data**

In the player modal observer (~line 270), after fetching recent results, compute placement percentiles:

```r
# Get last 15 tournament results for sparkline
sparkline_data <- safe_query(rv$db_con, "
  SELECT r.placement, t.player_count
  FROM results r
  JOIN tournaments t ON r.tournament_id = t.tournament_id
  WHERE r.player_id = ?
    AND r.placement IS NOT NULL
    AND t.player_count IS NOT NULL
    AND t.player_count >= 4
  ORDER BY t.event_date ASC
", params = list(player_id), default = data.frame())

# Compute placement percentile (1.0 = 1st place, 0.0 = last)
if (nrow(sparkline_data) >= 3) {
  percentiles <- 1 - (sparkline_data$placement - 1) / (sparkline_data$player_count - 1)
  percentiles <- pmin(pmax(percentiles, 0), 1)  # clamp
  # Use last 15 results
  if (length(percentiles) > 15) percentiles <- tail(percentiles, 15)
  sparkline_html <- make_sparkline_svg(percentiles)
} else {
  sparkline_html <- NULL
}
```

**Step 3: Insert sparkline into the Rating stat box**

In the modal stat boxes section (~line 340), add the sparkline below the rating number:

```r
# Current rating stat box
div(
  class = "modal-stat-box",
  div(class = "modal-stat-label", "Rating"),
  div(class = "modal-stat-value", rating_display),
  if (!is.null(sparkline_html)) HTML(sparkline_html)
)
```

**Step 4: Add CSS for sparkline**

```css
/* Rating sparkline in player modal */
.rating-sparkline {
  display: block;
  margin-top: 4px;
  opacity: 0.8;
}

.modal-stat-box:hover .rating-sparkline {
  opacity: 1;
}
```

**Step 5: Test**

- Player with many events (>5): should show sparkline with visible trend
- Player with 1-2 events: no sparkline shown
- Player with 0 events: no sparkline
- Verify the green/red dot shows correct trend direction

**Step 6: Commit**

```bash
git add server/public-players-server.R www/custom.css
git commit -m "feat(UX3): add rating trend sparkline to player modal"
```

---

## Task 12: I7 — Replace Header Icon with Digivice SVG

Replace the cards icon in the app header with a Digivice SVG from copyicon.com.

**Files:**
- Modify: `app.R` (~line 449, inline SVG in header)

**Current state:** An inline SVG of overlapping cards (two-path fan shape). Comment says "placeholder until digivice icon is found."

**Step 1: Get the Digivice SVG**

Visit https://copyicon.com/icons?keyword=digimon and copy the Digivice SVG. The SVG should use `stroke="currentColor"` or `fill="currentColor"` to inherit the white header color.

**Step 2: Replace the inline SVG**

In `app.R` (~line 449-457), replace the existing `HTML('<svg ...')` block with the new Digivice SVG. Keep the same `viewBox` sizing (14×14 or adjust) and ensure it uses `currentColor`.

```r
span(
  class = "header-icon",
  HTML('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="20" width="20" fill="currentColor">
    <!-- Digivice SVG paths from copyicon.com -->
  </svg>')
)
```

**Step 3: Adjust CSS if needed**

The existing `.header-icon svg` rule handles sizing (`1.4rem × 1.4rem`) and the cyan glow pulse animation. Verify the new SVG looks good with these styles. If the icon is too detailed at small sizes, increase to `1.6rem`.

**Step 4: Test**

- Header icon should show Digivice
- Cyan glow pulse animation should work
- Mobile: check icon doesn't overlap title text

**Step 5: Commit**

```bash
git add app.R
git commit -m "feat(I7): replace header cards icon with Digivice SVG"
```

---

## Task 13: BR1 — Agumon SVG on Loading Screen

Add an Agumon SVG to the loading screen for personality.

**Files:**
- Modify: `app.R` (~line 368-373, loading HTML template)
- Modify: `www/custom.css` (LOADING SCREEN section ~line 3906)

**Current state:** Loading screen has an animated dual-ring spinner (`.loading-gate`) with a cyan center glow. No character art.

**Step 1: Get the Agumon SVG**

Visit https://copyicon.com/icons?keyword=digimon and copy the Agumon SVG.

**Step 2: Insert SVG into loading HTML**

In `app.R` (~line 368), update the loading HTML template:

```js
var loadingHTML = '<div class="app-loading-overlay">' +
  '<div class="loading-scanline"></div>' +
  '<div class="loading-character">' +
    '<svg ...><!-- Agumon SVG paths --></svg>' +
  '</div>' +
  '<div class="loading-gate"><div class="loading-gate-center"></div></div>' +
  '<div class="loading-message">Opening Digital Gate...</div>' +
  '<div class="loading-submessage">Establishing connection</div>' +
'</div>';
```

**Step 3: Add CSS for the character**

```css
.loading-character {
  width: 80px;
  height: 80px;
  margin-bottom: 1rem;
  animation: character-bob 2s ease-in-out infinite;
  opacity: 0.9;
}

.loading-character svg {
  width: 100%;
  height: 100%;
}

@keyframes character-bob {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}
```

**Step 4: Test**

- Loading screen should show Agumon above the gate spinner
- Gentle bobbing animation
- Looks good on both light and dark backgrounds (the loading screen is always dark blue)

**Step 5: Commit**

```bash
git add app.R www/custom.css
git commit -m "feat(BR1): add Agumon SVG to loading screen"
```

---

## Task 14: M1 — Mobile Table Column Prioritization

Improve mobile table readability by hiding more secondary columns and keeping essential ones.

**Files:**
- Modify: `www/custom.css` (MOBILE TABLES section ~line 3750)

**Current state:** Only hides L, T, 1st, Top 3 columns on Players table at `max-width: 768px`. Doesn't address Meta, Tournaments, or modal tables.

**Step 1: Define column priority tiers**

Determine which columns to keep on mobile for each table:

**Players table:**
- Keep: #, Player, W, Win%, Rating
- Hide: L, T, 1st, Top 3, Score, Events (already hiding L, T, 1st, Top 3)

**Deck Meta table:**
- Keep: #, Deck, Entries, Win%
- Hide: Wins, Color, Conversion Rate

**Tournaments table:**
- Keep: Date, Store, Players, Winner
- Hide: Format, Event Type

**Recent Results in player modal:**
- Keep: Date, Deck, Place
- Hide: Store, Record

**Step 2: Update CSS**

```css
@media (max-width: 768px) {
  /* === Players table === */
  .rt-table [data-col-id="L"],
  .rt-table [data-col-id="T"],
  .rt-table [data-col-id="1st"],
  .rt-table [data-col-id="Top 3"],
  .rt-table [data-col-id="Losses"],
  .rt-table [data-col-id="Ties"],
  .rt-table [data-col-id="1st Places"],
  .rt-table [data-col-id="Top 3 Finishes"],
  .rt-table [data-col-id="Score"],
  .rt-table [data-col-id="Events"] {
    display: none !important;
  }

  /* === Deck Meta table === */
  .rt-table [data-col-id="Wins"],
  .rt-table [data-col-id="Color"],
  .rt-table [data-col-id="Conversion"] {
    display: none !important;
  }

  /* === Tournaments table === */
  .rt-table [data-col-id="Format"],
  .rt-table [data-col-id="Event Type"],
  .rt-table [data-col-id="Type"] {
    display: none !important;
  }

  /* Reduce padding for density */
  .reactable { font-size: 0.8rem; }
  .rt-th { padding: 0.4rem 0.5rem !important; font-size: 0.75rem !important; }
  .rt-td { padding: 0.35rem 0.5rem !important; }
}
```

**Step 3: Verify column IDs**

Check the actual `colDef()` names used in each server file:
- `server/public-players-server.R` — look for `colDef` names
- `server/public-meta-server.R` — same
- `server/public-tournaments-server.R` — same

The CSS `[data-col-id]` must exactly match the column accessor names. If names differ, update the CSS selectors.

**Step 4: Test on mobile viewport**

- Chrome DevTools → toggle device toolbar → 375px width
- Each tab table should be readable with only essential columns
- Tables should not horizontally scroll

**Step 5: Commit**

```bash
git add www/custom.css
git commit -m "feat(M1): comprehensive mobile table column prioritization"
```

---

## Task 15: BF1 — Admin Table Row Selection Audit

Fix admin tables that use `onClick = "select"` (index-based) with sorting enabled — selecting a row after sorting returns the wrong record.

**Files:**
- Modify: `server/admin-players-server.R` (~line 70)
- Modify: `server/admin-decks-server.R` (~line 268)

**Current state:**
| Table | Pattern | Sortable | Bug? |
|-------|---------|----------|------|
| Tournaments | JS onClick + ID | N/A | No — uses row data directly |
| Stores | `onClick = "select"` | `sortable = FALSE` | No — sorting disabled |
| **Players** | **`onClick = "select"`** | **Default (TRUE)** | **Yes — index shifts on sort** |
| **Decks** | **`onClick = "select"`** | **Default (TRUE)** | **Yes — index shifts on sort** |

**Step 1: Fix admin-players-server.R**

Option A (simple): Disable sorting like stores does.
Option B (robust): Switch to JS onClick pattern that passes the actual ID.

**Recommend Option B** for consistency with tournaments pattern:

```r
# Before (~line 70-85)
reactable(data, compact = TRUE, striped = TRUE,
  selection = "single",
  onClick = "select",
  ...
)

# After
reactable(data, compact = TRUE, striped = TRUE,
  selection = "single",
  onClick = JS("function(rowInfo, column) {
    if (rowInfo) {
      Shiny.setInputValue('player_list_clicked', {
        player_id: rowInfo.row.player_id || rowInfo.row['Player ID'] || rowInfo.row.ID,
        nonce: Math.random()
      }, {priority: 'event'});
    }
  }"),
  highlight = TRUE,
  ...
)
```

And update the observer:

```r
# Before
observeEvent(input$player_list__reactable__selected, {
  selected_idx <- input$player_list__reactable__selected
  ...
})

# After
observeEvent(input$player_list_clicked, {
  player_id <- input$player_list_clicked$player_id
  ...
})
```

**Step 2: Fix admin-decks-server.R**

Same pattern — switch from index-based to ID-based:

```r
# Replace onClick = "select" with JS that passes archetype_id
onClick = JS("function(rowInfo, column) {
  if (rowInfo) {
    Shiny.setInputValue('archetype_list_clicked', {
      archetype_id: rowInfo.row.archetype_id || rowInfo.row['Archetype ID'] || rowInfo.row.ID,
      nonce: Math.random()
    }, {priority: 'event'});
  }
}")
```

And update the observer from `input$archetype_list__reactable__selected` to `input$archetype_list_clicked`.

**Step 3: Verify the column name in row data**

Check what column names reactable exposes in `rowInfo.row` — this depends on the `colDef` accessor names. Read the `reactable()` call to confirm. May need `rowInfo.row.ID` or `rowInfo.row.player_id` depending on whether an ID column is included in the display data.

**Important:** If the ID column is hidden (not in `columns` list), it may not be in `rowInfo.row`. In that case, ensure the ID column is included in the data even if visually hidden with `show = FALSE`:

```r
columns = list(
  player_id = colDef(show = FALSE),  # Include but hide
  ...
)
```

**Step 4: Test**

- Sort admin players by different columns → click a row → verify correct player loads
- Sort admin decks by name → click a row → verify correct archetype loads
- Verify stores still works (unchanged)

**Step 5: Commit**

```bash
git add server/admin-players-server.R server/admin-decks-server.R
git commit -m "fix(BF1): switch admin tables to ID-based row selection"
```

---

## Implementation Order

Recommended sequence (dependencies and risk considered):

| Phase | Tasks | Rationale |
|-------|-------|-----------|
| 1. Quick CSS wins | UP1, UP2, UP5, UP8, M1 | Pure CSS, no risk, fast |
| 2. CSS + minor R | UP3, UP4, UP7 | CSS + small R/JS changes |
| 3. Server logic | UP6, UP9, UP10 | R server changes, need testing |
| 4. New feature | UX3 | New sparkline feature, most complex |
| 5. SVG assets | I7, BR1 | Depends on obtaining SVGs from copyicon.com |
| 6. Bug fix | BF1 | Admin-only, test carefully |

**Total estimated scope:** ~15 focused tasks, mostly CSS and minor R changes. Two tasks (UX3 sparkline, BF1 audit) require more careful implementation and testing. Two tasks (I7, BR1) depend on external SVG assets.

---

## Notes for Implementer

1. **CSS file is ~6000 lines** — always search for the right section before adding. Use the section header comments to navigate.
2. **`#F7941D` is the brand orange** — used ~25 times across CSS. Don't change it globally, only where specified.
3. **`atom_mapgl()`** is from the `atomtemplates` package — wraps Mapbox GL JS. The `htmlwidgets::onRender()` approach lets us call Mapbox GL JS APIs directly.
4. **Column IDs for mobile hiding** — verify actual `colDef` accessor names before adding CSS selectors. Use browser DevTools to inspect `data-col-id` attributes.
5. **The loading screen HTML is injected via JS** (not R UI) — edit the string in `app.R` lines 363-375.
6. **`reactable` row selection** — when using `onClick = JS(...)`, also set `selection = "single"` and `highlight = TRUE` for visual feedback.
